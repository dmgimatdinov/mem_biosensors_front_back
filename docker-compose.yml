# docker-compose.yml — local development / DigitalOcean App Platform
# Builds and runs the single combined image locally on port 80.
#
# Usage:
#   docker compose up --build        # build and start
#   docker compose up -d             # run in background
#   docker compose logs -f           # tail logs
#   docker compose down              # stop and remove containers

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Provide the public API URL baked into the Next.js static build.
        # Leave empty so the SPA uses the same origin (nginx proxies /api/*).
        NEXT_PUBLIC_API_URL: ""
    image: mem-biosensors:latest
    container_name: mem_biosensors_app
    ports:
      - "80:80"         # nginx → browser
    environment:
      # ── Backend runtime environment variables ──────────────
      DATABASE_URL: sqlite:///./memristive_biosensor.db
      LOG_LEVEL: INFO
      WORKERS: 1
      # Add any additional backend env vars here, e.g.:
      # SECRET_KEY: changeme
      # ALLOWED_ORIGINS: http://localhost
    volumes:
      # Persist the SQLite database between container restarts
      - db_data:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  db_data:
